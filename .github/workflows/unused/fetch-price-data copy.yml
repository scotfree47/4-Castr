name: Fetch Price Data

on:
  schedule:
    # Every 5 minutes during extended market hours (7 AM - 8 PM EST = 12:00 - 01:00 UTC next day)
    # GitHub Actions doesn't support every 1 minute - minimum is every 5 minutes
    - cron: '*/5 12-23 * * 1-5'  # 7 AM - 6:55 PM EST Mon-Fri
    - cron: '*/5 0 * * 1-5'      # 7 PM - 7:55 PM EST Mon-Fri
    - cron: '*/5 0-1 * * 2-6'    # 7 PM - 8 PM EST (crosses to next day UTC)

  workflow_dispatch:

jobs:
  fetch-prices:
    runs-on: ubuntu-latest

    steps:
      - name: üìà Fetch Current Price Data
        run: |
          echo "üìä Fetching price data at $(date)"

          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            https://4castr.vercel.app/api/cron-update-prices)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ö†Ô∏è Price fetch returned non-200 status"
            exit 1
          fi

          echo "‚úÖ Price data updated successfully"
