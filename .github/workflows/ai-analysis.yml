# .github/workflows/ai-analysis.yml
name: AI Architecture Analysis

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Manual trigger

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for change analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run AI analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_MODELS_ENDPOINT: https://models.inference.ai.azure.com
          MODEL_ARCHITECT: gpt-4o-mini
          MODEL_REVIEWER: o3-mini
          MODEL_ANALYST: gpt-4o-mini
          MODEL_CODER: Codestral-25.01
          MODEL_EMBEDDINGS: text-embedding-3-small
        run: npm run ai:analyze

      - name: Create issue with findings
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Check if report exists
            if (!fs.existsSync('ai-analysis-report.md')) {
              console.log('No report found, skipping issue creation');
              return;
            }

            const report = fs.readFileSync('ai-analysis-report.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `AI Architecture Analysis - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['ai-analysis', 'architecture']
            });
